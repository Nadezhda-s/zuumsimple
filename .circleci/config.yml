version: 2.1
orbs:
  newman: postman/newman@0.0.2
jobs:
  newman-collection-run-env:
    executor: newman/postman-newman-docker
    steps:
      - checkout
      - run:
          name: Get collections
          command: |
              apk add --update -q curl jq && npm config set unsafe-perm true && npm install postman-combine -g && mkdir -p collections
              echo $COLLECTIONS | tr ';' '\n' | while read COLLECTION; do curl -s https://api.getpostman.com/collections/$COLLECTION?apikey=$API_KEY | jq -c '.collection' > collections/$COLLECTION.json; done
              postman-combine -dest coll.json -d collections
      - newman/newman-run:
           collection: coll.json
           environment: https://api.getpostman.com/environments/$CURRENT_ENV1?apikey=$API_KEY

workflows:
  version: 2
  Some Random Workflow:
    jobs:
      - newman-collection-run-env
