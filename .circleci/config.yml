# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
# Use a package of configuration called an orb.
orbs:
  # Declare a dependency on the welcome-orb
  jq: circleci/jq@2.2.0
  newman: postman/newman@0.0.2
# 
jobs:
  newman-collection-run:
    parameters:
      envs:
        description: project environments
        default: "'14096194-232d230d-7d84-4e62-840e-276098f18a42' '14096194-747dceb4-778a-4653-9566-22572ff9c169'"
        type: string
    executor: newman/postman-newman-docker
    steps:      
      - checkout       
      - run:          
          name: Validate terraform code
          command: |
            apk add --update jq curl curl-dev |
            npm i newman |
            echo "my artifact file" > /tmp/artifact-1;
            mkdir /tmp/artifacts-tests;
            echo "my artifact files in a dir" > /tmp/artifacts/artifact-1;
            printf "SRART code\n"            
            c_line=1
            COLLECTIONS=$(eval `echo "curl --silent --location --request GET \"https://api.getpostman.com/workspaces/ae97ca88-e6f4-45f0-a52b-b98b062147d6\" --header \"X-API-Key: PMAK-60114e5616781300515026ea-3880a4a028557edf774fbb4d0a705088a0\"| jq -r '.workspace.collections[]'"`)
            CNT=$(echo $COLLECTIONS | jq -s '.' | jq length)
            CURRENT_COLLECTIONS="Test CREATE Company Trailer;Test CONTACT DELETE1;Demo"
            CURRENT_CNT=$(echo ${CURRENT_COLLECTIONS} | awk -F ';' '{print NF}')
            echo "Number of Postman collections: $CNT"
            echo "Number of current collections: $CURRENT_CNT"
            echo "Current collections: "
            cc_index=1
            while [ $cc_index -lt $(expr $CURRENT_CNT + 1) ]; do
            	code=$(echo "echo \${CURRENT_COLLECTIONS} | awk -F ';' '{ print $"${cc_index} "}'")
              cc=$(eval "$code")
              cc_index=$(expr $cc_index + 1)
            done            
            c_index=0
            echo "##################################"
            while [ $c_index -lt $(expr $CNT + 1) ]; do              
              code=$(echo "echo \$COLLECTIONS | jq '{id, name}' | jq -s '.' | jq -r '.[${c_index}] | \"\(.id)\\t\(.name)\"'")                
              c=$(eval "$code")
              #echo "Collection: $c"
              id=$(echo $c | cut -d' ' -f1)
              name=$(echo $c | cut -d' ' -f2-)
              #echo "   -- ID:   ${id}"
              #echo "   -- Name: ${name}"
              cc_index=1
              while [ $cc_index -lt $(expr $CURRENT_CNT + 1) ]; do
                code=$(echo "echo \${CURRENT_COLLECTIONS} | awk -F ';' '{ print $"${cc_index} "}'")
                cc=$(eval "$code")
                #echo "  -- CUR_NAME: ${cc}"
                if [ "$name" = "$cc" ]; then                	
                  newman run https://api.getpostman.com/collections/$id?apikey=PMAK-60114e5616781300515026ea-3880a4a028557edf774fbb4d0a705088a0 --environment https://api.getpostman.com/environments/14096194-0aa36cea-54f6-4110-839c-8c6f34d21221?apikey=PMAK-60114e5616781300515026ea-3880a4a028557edf774fbb4d0a705088a0 
                  #echo "COLLECTION FOUND!!! ${cc}"
                fi;                
                cc_index=$(expr $cc_index + 1)
              done
              c_index=$(expr $c_index + 1)              
            done;

      #- newman/newman-run:
          #collection: https://api.getpostman.com/collections/14096194-232d230d-7d84-4e62-840e-276098f18a42?apikey=PMAK-60114e5616781300515026ea-3880a4a028557edf774fbb4d0a705088a0 --environment https://api.getpostman.com/environments/14096194-0aa36cea-54f6-4110-839c-8c6f34d21221?apikey=PMAK-60114e5616781300515026ea-3880a4a028557edf774fbb4d0a705088a0
      - store_artifacts:
          path: /tmp/artifacts-1

      - store_artifacts:
          path: /tmp/artifacts-tests

# Orchestrate or schedule a set of jobs
workflows:
  version: 2
  Some Random Workflow:
    jobs:
      - newman-collection-run  
